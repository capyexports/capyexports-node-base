---
description: 规范 Node.js 22 Base Docker 镜像的构建、推送及子项目引用的流程与标准。
globs: ["Dockerfile", ".github/workflows/*.yml", "**/deploy/**"]
---

# Base Docker & CI/CD 架构规范

## 1. 核心定义 (Standard Reference)
- **Base Image 名称**: `capyexports-node-base`
- **基础环境**: Node.js 22 (Alpine 版)
- **目标仓库**: 阿里云 ACR 上海地域 (`registry.cn-shanghai.aliyuncs.com`)
- **部署节点**: 火山引擎 Ubuntu 实例 (4核4G/40GB)

## 2. Base Dockerfile 构建标准
当修改或生成 Base Dockerfile 时，必须满足以下要求：
- **时区校准**: 必须包含 `tzdata` 安装并设置为 `Asia/Shanghai`。
- **镜像加速**: 必须配置 `npm config set registry https://registry.npmmirror.com`。
- **极简原则**: 严禁安装非通用依赖，仅保留运行时必需工具（如 `ca-certificates`）。
- **非 Root 运行**: 必须使用 `USER node` 运行应用。

## 3. GitHub Actions 流水线逻辑
- **触发条件**: 仅在 `Dockerfile` 或工作流文件变更时触发。
- **标签策略**: 必须同时推送 `:latest` 和 `:${{ date }}` 格式的标签。
- **敏感信息**: 严禁硬编码密码；一律使用 **Organization secrets**：`ACR_USERNAME`、`ACR_PASSWORD`、`ACR_NAMESPACE`。在组织设置中为仓库授予访问权限后，workflow 中直接引用即可，无需声明 environment。

## 4. 40GB 磁盘空间约束 (Disk Space Constraint)
- **日志限制**: 所有容器必须在 `docker-compose.yml` 或 `daemon.json` 中限制日志大小为 `max-size: 20m`。
- **层复用**: 引导用户在所有子项目（如 capyexports）中使用 `FROM [ACR_BASE_IMAGE_URL]` 以复用层，严禁重复拉取 Node 官方镜像。
- **自动清理**: 在部署脚本结尾必须附加 `docker image prune -f` 逻辑。

## 5. 指令触发器
- 当用户询问“如何添加新项目”时，引导其使用多阶段构建并引用此 Base Image。
- 当用户询问“构建失败”时，优先检查 ACR 登录状态和网络连通性。

## 6. 风险审计 (Pre-response Audit)
- 是否使用了 `alpine` 镜像？ (是)
- 是否配置了国内 npm 源？ (是)
- 是否有针对 40GB 硬盘的清理指令？ (是)